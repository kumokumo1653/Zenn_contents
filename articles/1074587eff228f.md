---
title: "Chromeæ‹¡å¼µæ©Ÿèƒ½ã®æ¦‚è¦ã‹ã‚‰å…¬é–‹ã¾ã§(ManifestV3å¯¾å¿œ) ~é–‹ç™ºç·¨~"
emoji: "ğŸ–¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["javascript", "chrome"]
published: true
---

# ã¯ã˜ã‚ã«
ManifestV3ã§Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚’å…¬é–‹ã—ãŸã®ã§å…¬é–‹ã¾ã§ã®æµã‚Œã‚’è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚
æœ¬è¨˜äº‹ã¯é–‹ç™ºç·¨ã§ã™ã€‚é–¢é€£è¨˜äº‹ã¯ã“ã¡ã‚‰ã€‚

æœ¬è¨˜äº‹ã§ã¯é–‹ç™ºã§ä½¿ã£ãŸAPIã‚„å°ãƒã‚¿ã‚’è§£èª¬ã—ã¾ã™ã€‚ã“ã“ã§è§£èª¬ã™ã‚‹ã‚‚ã®ã¯ä½œã‚‹æ‹¡å¼µæ©Ÿèƒ½æ¬¡ç¬¬ã§ã¯é–¢ä¿‚ãªã„éƒ¨åˆ†ã‚‚å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# ãƒ‡ãƒãƒƒã‚¯æ–¹æ³•
å…¬é–‹ã™ã‚‹å ´åˆã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’åœ§ç¸®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ‡ãƒãƒƒã‚¯ã™ã‚‹å ´åˆã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§æ‹¡å¼µæ©Ÿèƒ½ã‚’å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚[æ‹¡å¼µæ©Ÿèƒ½ã®ç®¡ç†ãƒšãƒ¼ã‚¸](chrome://extensions/)ã‹ã‚‰"ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€"ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã™ã‚‹ã“ã¨ã§æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚æ‹¡å¼µæ©Ÿèƒ½ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ãŸå ´åˆã¯æ‹¡å¼µæ©Ÿèƒ½ã®å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§æ›´æ–°ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚ãªãŠã€Content Scriptsã‚’æ›´æ–°ã—ãŸå ´åˆã¯è©²å½“ã®webãƒšãƒ¼ã‚¸ã‚‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
![](/images/1074587eff228f/extensionpage.png)
*ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€*

# Message Passing
æ¦‚è¦ç·¨ã§ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸãŒã€å…·ä½“çš„ã«é€ä¿¡å´ã¨å—ä¿¡å´ã«å®Ÿè£…ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
é€ä¿¡å´ã¯`tabs.sendMessage`ã‹`runtime.sendMessage`ã‚’ä½¿ã„ã¾ã™ã€‚
`tabs.sendMessage`ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸­èº«ã¨é€ä¿¡ã™ã‚‹ã‚¿ãƒ–IDã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚ã‚¿ãƒ–æƒ…å ±ã¯`chrome.tabs.query()`ã§å–å¾—ã§ãã¾ã™ã€‚ã„ã¤ã‹ã‚‰ã‹APIãŒPromiseè¿”ã™ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ(ManifestV3ã‹ã‚‰ï¼Ÿ)ã€‚ã¾ã å¯¾å¿œã—ã¦ã„ãªã„APIã‚‚ã‚ã‚‹ã®ã§å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚
responseã«ã¯`onMessage`ã§è¿”ã•ã‚ŒãŸå€¤ãŒå…¥ã‚Šã¾ã™ã€‚

```js:sender.js
//runtime.sendMessageã®å ´åˆ
const response = await chrome.runtime.sendMessage({"message":"hogehoge"});

//tabs.sendMessageã®å ´åˆ
chrome.tabs.query({}).then((result) => {
    result.forEach((tab) => {
    if (tab.url.match(/https:\/\/hogehoge.jp\/.*/)) {
        const response = await chrome.tabs.sendMessage(tab.id, {"message":"hogehoge"});
    }
    });
});
```

å—ä¿¡å´ã¯`chrome.runtime.onMessage.addListener()`ã§Listenã—ã¾ã™ã€‚
ã“ã“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ãŸå‡¦ç†ã‚’è¡Œã„ã€`sendResponse()`ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
ã“ã®ã¨ã`true`ã‚’è¿”ã•ã‚Œãªã„ã¨`sendMessage`ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚Œã¾ã›ã‚“(1æ•—)ã€‚
https://zwzw.hatenablog.com/entry/2019/12/04/200000
```js:receiver.js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type == 'open') {
    //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ãŸå‡¦ç†
    chrome.tabs.create({ url: 'mylibrary.html' }).then((response) => {
      sendResponse({ result: 'success', tab: response.id });
    });
  }
  return true; //trueã‚’è¿”ã™ã€‚
});
```
# ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œã‚‹ã¨è¨­å®šé …ç›®ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸã„ã‚±ãƒ¼ã‚¹ãŒå‡ºã¦ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
`chrome.storage`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒã§ãã¾ã™ã€‚ä¿å­˜å ´æ‰€ã‚’ç”¨é€”ã«åˆã‚ã›ã¦é¸ã‚“ã§ãã ã•ã„ã€‚ä¿å­˜ã§ãã‚‹å®¹é‡ã«ã‚‚åˆ¶é™ãŒã‚ã‚‹ã®ã§`chrome.storage.local`ãŒç„¡é›£ãã†ã€‚
| API | ç‰¹å¾´ |
| ---- | ---- | 
| storage.local | ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å®¹é‡ã¯5MBã¾ã§ã€‚`unlimitedStorage`ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨å®¹é‡ã‚’æ‹¡å¼µã§ãã¾ã™ã€‚ | 
| storage.sync | Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åŒæœŸã—ãŸé ˜åŸŸã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã§ãã¾ã™ã€‚å®¹é‡ã¯100kBã¾ã§ã€‚ | 
| storage.session | ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿é ˜åŸŸã§ã™ã€‚å®¹é‡ã¯10MBã¾ã§ã€‚ | 

ã“ã‚Œã‚‰ã¯manifest.jsonã®`permissions`ã«`storage`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```json
  "permissions": ["storage"],
```

storageã«ã¯key-valueæ–¹å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚
```js:storage.js
    //get keyã‚’æŒ‡å®šã—ã¦valueã‚’å–å¾— 
    chrome.storage.local
      .get("theme")
      .then((value) => {
        //ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ãŸå‡¦ç†
      });

    //set key-valueã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    chrome.storage.local
      .set({ "theme": "dark" })
      .then(() => {
        console.log("Value is set");
      });
```
# cookieã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
æ‹¡å¼µæ©Ÿèƒ½ã«ã‚ˆã£ã¦ã¯cookieã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ï¼ˆãƒ¦ãƒ¼ã‚¶æ“ä½œã«å¤‰ã‚ã£ã¦é€šä¿¡ã—ãŸã„ã¨ãã¨ã‹ï¼‰
manifest.jsonã«`permissions`ã¨`host_permissions`ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ç§ã¯cookieã®å–å¾—ã—ã‹ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€è¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚
https://developer.chrome.com/docs/extensions/reference/cookies/
```json
  "permissions": ["cookies"],
  "host_permissions": ["*://hoge.jp/"],
```

`getAll`ã§`host_permissions`ã§æŒ‡å®šã—ãŸãƒ›ã‚¹ãƒˆã®cookieã‚’ã™ã¹ã¦å–å¾—ã§ãã¾ã™ã€‚
```js
    const cookies = await chrome.cookies.getAll({});
```

# é€šä¿¡ã®ç›£è¦–
ãƒ¦ãƒ¼ã‚¶æ“ä½œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­èº«ã‚’å–å¾—ã—ã¦æ‹¡å¼µæ©Ÿèƒ½ã§å‡¦ç†ã—ãŸã„ãƒ¦ãƒ¼ã‚¹ãƒ¼ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šé€šä¿¡ã®ç›£è¦–æ–¹æ³•ã‚’èª¿ã¹ã¾ã—ãŸã€‚

ManifestV2ã¾ã§ã¯webRequestAPIã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­èº«ã‚’è¦‹ãŸã‚Šã€é€šä¿¡ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ããŸã‚Šã—ã¾ã—ãŸãŒManifestV3ã§å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚
ã‹ã‚ã‚Šã«`chrome.declarativeNetRequest`ã§é™çš„ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãªã©ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
`chrome.declarativeNetRequest`ã§é€šä¿¡ã®ç›£è¦–ãŒã§ããªãã†ã ã£ãŸã®ã§ä»–ã®æ–¹æ³•ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

è‰²ã€…èª¿ã¹ã¾ã—ãŸãŒä¸‹è¨˜ãƒªãƒ³ã‚¯ãŒå®Ÿè£…æ–¹æ³•å«ã‚ã¾ã¨ã¾ã£ã¦ã„ãŸã®ã§ã“ã‚Œã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚
https://medium.com/@ddamico.125/intercepting-network-response-body-with-a-chrome-extension-b5b9f2ef9466

å®Ÿè£…æ–¹æ³•ã¨ã—ã¦ã¯`XMLHttpRequest`ã«ãƒ¢ãƒ³ã‚­ãƒ¼ãƒ‘ãƒƒãƒã‚’é©ç”¨ã—ã¦`XMLLHttpRequest.prototype.open`ã¨`XMLHttpRequest.send`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®payloadã¨responseã‚’å–å¾—ã—ã¾ã™ã€‚

```js:injectedScript.js
// define monkey patch function
const monkeyPatch = () => {
  let oldXHROpen = window.XMLHttpRequest.prototype.open;
  window.XMLHttpRequest.prototype.open = function () {
    this.addEventListener('load', function () {
      const responseBody = this.responseText;
      document.getElementById('myDataHolder').setAttribute('response', responseBody);
    });
    return oldXHROpen.apply(this, arguments);
  };

  let oldXHRsend = window.XMLHttpRequest.prototype.send;
  window.XMLHttpRequest.prototype.send = function (postData) {
    document.getElementById('myDataHolder').setAttribute('payload', postData);
    return oldXHRsend.apply(this, arguments);
  };
};
monkeyPatch();
```

è£œè¶³ã¨ã—ã¦`injectedScript`ã‚’å…ƒãƒªãƒ³ã‚¯ã§ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§webãƒšãƒ¼ã‚¸ã«æŒ¿å…¥ã—ã¦ã„ã¾ã™ãŒã€ManifestV3ã§ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚åˆ¥é€”javascrptãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ¿å…¥ã™ã‚‹å®Ÿè£…ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ãã‚Œã«ä¼´ã„manifest.jsonã«ä¸‹è¨˜è¨˜è¿°ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```js:inject.js
const injectScript = () => {
  var script = document.createElement('script');
  script.setAttribute('src', chrome.runtime.getURL('injectedScript.js'));
  (document.head || document.documentElement).appendChild(script);
  script.remove();
};
```

```json:manifest.json
  "web_accessible_resources": [
    {
      "resources": ["injectedScript.js"],
      "matches": ["https://shop.nijisanji.jp/*"]
    }
  ],
```
å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰webãƒšãƒ¼ã‚¸ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«`web_accessible_resouces`ã§ãƒªã‚½ãƒ¼ã‚¹ã¨webãƒšãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™ã€‚

